const amqplib = require('amqplib');

// connection jha apna rabitmq -> cloudamqp run ho rha hai aur uska url store ho rha hai or sare message store ho rhe hai
// channel jo apka rabbitmq or notification service ke bich me jo connection bna hai use connection ke bich me apan multiple channel create kr skte hai aur alag alag channel apan alag alag cheezo ke liye use kr skte hai
// ideally sirf ek channel rhta hai lekin apan usse bdha skte hai
let channel, connection;

// ye function server ko connect krega rabbitMQ se
async function  connect() {
    // connection already exist krta hai toh return krdo connection
    if(connection) return connection;

    try{
        connection = await amqplib.connect(process.env.RABBIT_URL);
        console.log("Connected to RabbitMQ");
        channel = await connection.createChannel();
    }
    catch(error){
        console.log("Error connection to RabbitMQ: ", error);
    }
}

// Ye function kisi bhi ek message ko queue me dalega
// isme data jo hai vo by default object form me hi rhega 
async function  publishToQueue(queueName, data={}) {
    if(!channel || !connection) await connect();

    // assertQueue ye krti hai ki agar queue exist krti hai toh message us me daal degi aur agar queue exist nhi krti toh queue create krke usme message dal degi
    await channel.assertQueue(queueName, {
        durable: true
    });

    // RabbitMQ jo data transfer krta hai vo buffer format me krta hai(binary format me krta hai)
    channel.sendToQueue(queueName, Buffer.from(JSON.stringify(data)));
    console.log("Message send to queue: ", queueName, data);
}

// ye function jab koi sa bhi data ayega queue me toh uske liye callback chlayega
// message ko read krne ke liye jese hi queue me data aye authentication service se notification service ko pta chl jaye iske liye notification service queue ko subscribe krke rhkti hai(mtlb ye ki data queue me ate hi notification service ko de diya jayega)
// isme queueName mtlb aap kis queue ko subscribe krna chaha rhe ho uska name aur sath me jo data ayega us data ke sath kya krna chahte ho us data ke liye particular callack
async function subscribeToQueue(queueName, callback) {
    if(!channel || !connection) await connect();

     await channel.assertQueue(queueName, {
        durable: true
    });

    channel.consume(queueName, async(msg)=> {
        if(msg != null) {
            const data = JSON.parse(msg.content.toString());
            await callback(data);
            channel.ack(msg);
        }
    })
}

module.exports = {
    connect,
    channel,
    connection,
    publishToQueue,
    subscribeToQueue
}

// do kaam honge
// 1. message queue me dalna -> isko bolte hai publish queue
// 2. message queue se nikalna -> isko bolte hai consuming queue

